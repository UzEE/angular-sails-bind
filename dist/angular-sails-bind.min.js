/*! angular-sails-bind - v1.0.6 - 2015-01-15
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
function diff(a,b){return a.filter(function(a){return b.indexOf(a)<0})}var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$q","$rootScope","$timeout","$log",function(a,b,c,d){"use strict";var e=function(e,h,i){function j(a){var b=h[e+"s"],f={created:function(){return h[e+"s"].push(a.data),!0},updated:function(){var c=b.find(function(b){return a.id==b.id});return c?(angular.extend(c,a.data),!0):!1},destroyed:function(){var c=b.find(function(b){return a.id==b.id});return c?(b.splice(b.indexOf(c),1),!0):!1}};f[a.verb]?f[a.verb]()&&c(function(){h.$apply()}):d.log("Unknown action »"+a.verb+"«")}function k(){h.$watchCollection(e+"s",function(a,c){var d,i;a=a||[],c=c||[],d=diff(a,c),i=diff(c,a),i.forEach(function(a){g("/"+l+e+"/"+a.id).then(function(c){c&&!c.error&&(b.$broadcast(e,{id:a.id,verb:"destroyed",scope:h.$id}),io.socket["delete"]("/"+l+e+"/"+a.id))})}),d.forEach(function(c,d){c.id||io.socket.post("/"+l+e,c,function(f){f.hasOwnProperty("error")?(b.$broadcast(e,{verb:"createError",scope:h.$id,errors:angular.copy(f),item:angular.copy(c)}),a.splice(d,1)):(angular.extend(c,f),b.$broadcast(e,{id:c.id,verb:"created",scope:h.$id,data:angular.copy(c)}))})}),f(d,h,e,l)})}var l=e.split("/");l.length>1?(e=l.splice(l.length-1,1),l=l.join("/")+"/"):l="";var m=new a.defer,n=g("/"+l+e,i);return n.then(function(a){Array.isArray(a)||(a=[a]),h[e+"s"]=a,f(a,h,e,l),k(),m.resolve()}),io.socket.on(e,j),h.$on(e,function(a,b){h.$id!=b.scope&&j(b)}),m.promise},f=function(a,c,d,e){a.forEach(function(a){$scope.$watchCollection(d+"s["+c[d+"s"].indexOf(a)+"]",function(a,c){c&&a&&(angular.equals(c,a)||c.id!=a.id||c.updatedAt!==a.updatedAt||io.socket.put("/"+e+d+"/"+c.id,angular.copy(a),function(e){e.hasOwnProperty("error")?(b.$broadcast(d,{id:c.id,verb:"updateError",scope:$scope.$id,error:angular.copy(e),item:angular.copy(a)}),a=angular.copy(c)):(angular.extend(a,e),b.$broadcast(d,{id:c.id,verb:"updated",scope:$scope.$id,data:angular.copy(a)}))}))})})},g=function(c,d){var e=new a.defer;return d=d||{},io.socket.get(c,d,function(a){b.$apply(e.resolve(a))}),e.promise};return{bind:e}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});